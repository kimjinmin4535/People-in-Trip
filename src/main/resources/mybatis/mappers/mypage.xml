<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
  
<mapper namespace="mapper.mypage">
	<resultMap type="mypageDTO" id="mypageResult">
		<result property="id" column="id" />
		<result property="name" column="name" />
		<result property="pwd" column="pwd" />
		<result property="nick_nm" column="nick_nm" />
		<result property="email" column="email" />
		<result property="join_Date" column="join_Date" />
		<result property="last_update" column="last_update" />
		<result property="grade" column="grade" />
	</resultMap>
	
	<resultMap type="myboardDTO" id="myBoardResult">
		<result property="post_num" column="post_num" />
		<result property="id" column="id" />

		<result property="post_cate" column="post_cate" />
		<result property="post_title" column="post_title" />
		<result property="post_content" column="post_content" />
		<result property="post_date" column="post_date" />
		<result property="visitcount" column="visitcount" />
		<result property="count_comment" column="count_comment" />
	</resultMap>
	
	<resultMap type="kr.co.intrip.tourist.dto.Tourlist_SteamedDTO" id="tsDTO">
		<result property="steamedno" column="steamedno"/>
		<result property="contentsid" column="contentsid"/>
		<result property="id" column="id"/>
		<result property="steamedcheck" column="steamedcheck"/>
	</resultMap>
	
	<resultMap type="kr.co.intrip.tourist.dto.ApiDTO" id="apiDTO">
		<result property="alltag" column="alltag"/>
		<result property="label" column="label"/>
		<result property="label2" column="label2"/>
		<result property="title" column="title"/>
		<result property="address" column="address"/>
		<result property="tag" column="tag"/>
		<result property="introduction" column="introduction"/>
		<result property="imgpath" column="imgpath"/>
		<result property="contentsid" column="contentsid"/>
		<result property="phoneno" column="phoneno"/>
		<result property="latitude" column="latitude"/>
		<result property="longitude" column="longitude"/>
		<result property="viewcount" column="viewcount"/>
		<result property="commentcount" column="commentcount"/>
		<result property="steamedhit" column="steamedhit"/>
		<result property="suggestionhit" column="suggestionhit"/>
	</resultMap>

	<!-- 마이페이지 정보 조회 -->
	<select id="selectMemberMyPage" resultMap="mypageResult">
		<![CDATA[
			SELECT id ,
				   name,
				   pwd ,
				   nick_nm ,
				   email
			FROM P_MEMBER
			WHERE id = #{id}
		]]>
	</select>
	
	<!-- 비밀번호 변경 -->
	<select id="update_MyPage_Pw">
		<![CDATA[
			UPDATE P_MEMBER
			SET PWD = #{pwd}
			WHERE ID = #{id}
		]]>
	</select>
	
	<!-- 닉네임 변경 -->
	<select id="update_MyPage_nick_nm">
		<![CDATA[
			UPDATE P_MEMBER
			SET NICK_NM = #{nick_nm}
			WHERE ID = #{id}
		]]>
	</select>
	
	<!-- 닉네임 검사 -->
	<select id="selectNickChk" resultType="int">
		<![CDATA[
			SELECT COUNT(*)
			FROM P_MEMBER 
			WHERE NICK_NM = #{nick_nm}
		]]>
	</select>	
	
	<!-- 회원 탈퇴 -->
	<delete id="deleteMember">
		<![CDATA[
			DELETE FROM P_MEMBER 
			WHERE ID = #{id}
			AND PWD = #{pwd}	
		]]>
	</delete>
	
	<!-- 내가쓴 글 수정 -->
	
	<!-- 내가 쓴 동행글 -->
	<select id="listfindcompany" resultType="myboardDTO"
		parameterType="kr.co.intrip.board.dto.Criteria">
		select POST_NUM, POST_TITLE, POST_CONTENT, ID, POST_DATE, VISITCOUNT
		from (
				select POST_NUM, POST_TITLE, POST_CONTENT, ID, POST_DATE,
				VISITCOUNT,
		row_number() over(order by POST_NUM desc) as rNum
		from P_BOARD
		where id = #{id}
		<include refid="search"></include>
		ORDER by 1
		) mb
		where rNum between #{rowStart} and #{rowEnd}
		order by POST_NUM DESC
	</select>
	
	<!-- 내가 쓴 동행글 검색어 갯수 -->
	<select id="findlistCompanyCount" resultType="int"
		parameterType="kr.co.intrip.board.dto.Criteria">
		select count(post_num)
		from p_board
		where post_num > 0
		<include refid="search"></include>
	</select>
	
	<!-- 내가 쓴 정보글 -->
	<select id="listfindInformation" resultType="myboardDTO"
		parameterType="kr.co.intrip.board.dto.Criteria">
		select POST_NUM, POST_TITLE, POST_CONTENT, ID, POST_DATE, VISITCOUNT
		from (
				select POST_NUM, POST_TITLE, POST_CONTENT, ID, POST_DATE,
				VISITCOUNT,
		row_number() over(order by POST_NUM desc) as rNum
		from P_BOARD1
		where id = #{id}
		<include refid="search"></include>
		ORDER by 1
		) mb
		where rNum between #{rowStart} and #{rowEnd}
		order by POST_NUM DESC
	</select>

	<!-- 내가 쓴 정보글 검색어 갯수 -->
	<select id="findlistInfoCount" resultType="int"
		parameterType="kr.co.intrip.board.dto.Criteria">
		select count(post_num)
		from p_board1
		where post_num > 0
		<include refid="search"></include>
	</select>			
	
	<!-- 검색 -->
	<sql id="search">
		<if test="searchType != null">
			<if test="searchType == 't'.toString()">and POST_TITLE LIKE '%' || #{keyword} || '%'</if>
			<if test="searchType == 'c'.toString()">and POST_CONTENT LIKE '%' || #{keyword} || '%'</if>
			<if test="searchType == 'w'.toString()">and ID LIKE '%' || #{keyword} || '%'</if>
		</if>
	</sql>
	
	<!-- 내가 찜한글 조회 -->
	<select id="mySteamed" resultType="kr.co.intrip.tourist.dto.ApiDTO" parameterType="kr.co.intrip.tourist.dto.Tourlist_SteamedDTO">		
		SELECT a.IMGPATH, a.TITLE, a.CONTENTSID 
		FROM P_TOURIST a
		INNER JOIN TOURIST_STEAMED b
		ON a.CONTENTSID = b.CONTENTSID
		WHERE b.ID = #{id}
		AND b.STEAMEDCHECK = '1'
	</select>
	
	<sql id="jejusearch">
		<if test="searchType != null">
			<if test="searchType == 't'.toString()">and b.TITLE LIKE '%' || #{keyword, jdbcType=VARCHAR} || '%'</if>
			<if test="searchType == 'c'.toString()">and b.LABEL LIKE '%' || #{keyword, jdbcType=VARCHAR} || '%'</if>
			<if test="searchType == 'w'.toString()">and b.LABEL2 LIKE '%' || #{keyword, jdbcType=VARCHAR} || '%'</if>
		</if>
	</sql>
	
	<!-- 내가 찜한 글 총 개수 -->
	<select id="getTotalSteamedCount" parameterType="kr.co.intrip.board.dto.Criteria" resultType="int">
		SELECT COUNT(*)  
		FROM TOURIST_STEAMED b
		INNER JOIN P_TOURIST a
		ON b.CONTENTSID = a.CONTENTSID 
		WHERE STEAMEDNO > 0
		and b.ID = #{id}
		<include refid="jejusearch"></include>
	</select> 
	
	<!--내가 찜한 글 페이징 -->
	<select id="mySteamedJeju" resultType="kr.co.intrip.tourist.dto.ApiDTO"
		parameterType="kr.co.intrip.board.dto.Criteria">
		SELECT mb.IMGPATH, mb.title, mb.CONTENTSID
		from (
				select a.IMGPATH, a.title, a.CONTENTSID ,
					   row_number() over(order by b.STEAMEDNO  desc) as rNum
				from P_TOURIST a
				inner join TOURIST_STEAMED b
				on a.CONTENTSID = b.CONTENTSID 
				where b.ID = #{id}
				<include refid="jejusearch"></include>
				AND a.STEAMEDHIT = '1'
				order by 1
				) mb
		where rNum between #{rowStart} and #{rowEnd}
	</select> 
	
</mapper>