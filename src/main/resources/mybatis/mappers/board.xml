<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="mapper.board">
	<resultMap type="boardDTO" id="boardResult">
		<result property="post_num" column="post_num" />
		<result property="id" column="id" />
		<result property="post_title" column="post_title" />
		<result property="post_content" column="post_content" />
		<result property="post_date" column="post_date" />
		<result property="visitcount" column="visitcount" />
		<result property="count_comment" column="count_comment" />
	</resultMap>

	<resultMap type="imageDTO" id="imgResult">
		<result property="imageFileNO" column="imageFileNO" />
		<result property="imageFileName" column="imageFileName" />
		<result property="post_num" column="post_num" />

	</resultMap>

	<!-- 조회수 -->
	<update id="visitcount">
		UPDATE
		P_BOARD
		SET
		VISITCOUNT = visitcount + 1
		WHERE
		POST_NUM = #{post_num}
	</update>
	
	<!-- 조회수 -->
	<update id="visitcount1">
		UPDATE
		P_BOARD1
		SET
		VISITCOUNT = visitcount + 1
		WHERE
		POST_NUM = #{post_num}
	</update>

	<!-- 페이징 검색 -->
	<select id="listfind" resultType="boardDTO"
		parameterType="kr.co.intrip.board.dto.Criteria">
		select POST_NUM, POST_TITLE, POST_CONTENT, ID, POST_DATE, VISITCOUNT
		from (
		select POST_NUM, POST_TITLE, POST_CONTENT, ID, POST_DATE,
		VISITCOUNT,
		row_number() over(order by POST_NUM desc) as rNum
		from
		P_BOARD
		<include refid="search"></include>
		) mb
		where rNum between #{rowStart} and #{rowEnd}
		order by POST_NUM desc
	</select>

	<!-- 페이징 검색1 -->
	<select id="listfind1" resultType="boardDTO"
		parameterType="kr.co.intrip.board.dto.Criteria">
		select POST_NUM, POST_TITLE, POST_CONTENT, ID, POST_DATE, VISITCOUNT
		from (
		select POST_NUM, POST_TITLE, POST_CONTENT, ID, POST_DATE,
		VISITCOUNT,
		row_number() over(order by POST_NUM desc) as rNum
		from
		P_BOARD1
		<include refid="search"></include>
		) mb
		where rNum between #{rowStart} and #{rowEnd}
		order by POST_NUM desc
	</select>

	<!-- 검색 -->
	<sql id="search">
		<if test="searchType != null">
			<if test="searchType == 't'.toString()">where POST_TITLE LIKE '%' || #{keyword} || '%'</if>
			<if test="searchType == 'c'.toString()">where POST_CONTENT LIKE '%' || #{keyword} || '%'</if>
			<if test="searchType == 'w'.toString()">where ID LIKE '%' || #{keyword} || '%'</if>
		</if>
	</sql>

	<!--검색어 갯수 -->
	<select id="findlistCount" resultType="int"
		parameterType="kr.co.intrip.board.dto.Criteria">
		select count(post_num)
		from p_board
		<include refid="search"></include>
		where post_num > 0
	</select>

	<!--검색어 갯수 -->
	<select id="findlistCount1" resultType="int"
		parameterType="kr.co.intrip.board.dto.Criteria">
		select count(post_num)
		from p_board1
		<include refid="search"></include>
		where post_num > 0
	</select>

	<!-- 상세보기 -->
	<select id="selectBoard" parameterType="java.lang.Integer"
		resultType="boardDTO">
      <![CDATA[
         SELECT * FROM P_BOARD
         WHERE POST_NUM = #{post_num}   
      ]]>
	</select>
	
	<!-- 상세보기 -->
	<select id="selectBoard1" parameterType="java.lang.Integer"
		resultType="boardDTO">
      <![CDATA[
         SELECT * FROM P_BOARD1
         WHERE POST_NUM = #{post_num}   
      ]]>
	</select>

	<!-- 게시물 등록 -->
	<insert id="insertBoard" parameterType="java.util.Map">
   <![CDATA[
      INSERT INTO P_BOARD
      (POST_NUM, ID, POST_TITLE, POST_CONTENT)
      VALUES(#{post_num}, #{id}, #{post_title}, #{post_content})
   ]]>
	</insert>
	<!-- 게시물 등록1 -->
	<insert id="insertBoard1" parameterType="java.util.Map">
   <![CDATA[
      INSERT INTO P_BOARD1
      (POST_NUM, ID, POST_TITLE, POST_CONTENT)
      VALUES(#{post_num}, #{id}, #{post_title}, #{post_content})
   ]]>
	</insert>

	<!-- 추가하는 새글에 대한 글번호 가져옴 -->
	<select id="selectNewpost_num" resultType="int">   
      <![CDATA[    
         SELECT nvl(MAX(post_num),0) + 1 FROM P_BOARD
      ]]>
	</select>
	
	<!-- 추가하는 새글에 대한 글번호 가져옴 -->
	<select id="selectNewpost_num1" resultType="int">   
      <![CDATA[    
         SELECT nvl(MAX(post_num),0) + 1 FROM P_BOARD1
      ]]>
	</select>

	<select id="selectNewImageFileNO" resultType="int">
      <![CDATA[   
         SELECT nvl(MAX(imageFileNO),0) FROM P_imageFile
      ]]>
	</select>

	<select id="selectImageFileList" resultMap="imgResult"
		parameterType="int">
      <![CDATA[
         SELECT * FROM P_imageFile
         WHERE POST_NUM = #{post_num}
         ORDER BY IMAGEFILENO      
      ]]>
	</select>

	<!-- 한꺼번에 여러 개의 레코드 추가 -->
	<insert id="insertNewImage" parameterType="java.util.Map">
		<foreach collection="list" item="item" open="INSERT ALL"
			separator=" " close="SELECT * FROM DUAL">
			INTO P_imageFile(imageFileNO, imageFileName,
			post_num, regDate)
			VALUES
			(#{item.imageFileNO},#{item.imageFileName},#{item.post_num},sysdate)
		</foreach>
	</insert>

	<select id="selectpost_num" resultType="boardDTO"
		parameterType="int">
      <![CDATA[
         SELECT * FROM P_BOARD
         WHERE POST_NUM = #{post_num}   
      ]]>
	</select>


	<!-- 게시글 수정 -->
	<update id="updateBoard" parameterType="java.util.Map">
		<![CDATA[
			UPDATE P_BOARD 
				SET POST_TITLE = #{post_title}
					,POST_CONTENT = #{post_content}
				WHERE POST_NUM = #{post_num}		
		]]>
	</update>
	
	<!-- 게시글 수정 -->
	<update id="updateBoard1" parameterType="java.util.Map">
		<![CDATA[
			UPDATE P_BOARD1 
				SET POST_TITLE = #{post_title}
					,POST_CONTENT = #{post_content}
				WHERE POST_NUM = #{post_num}		
		]]>
	</update>

	<update id="updateImageFile" parameterType="java.util.List">
		<foreach collection="list" item="item" separator=";"
			open="DECLARE BEGIN" close="; END;">
			<choose>
				<when test="item.imageFileName != null">
					UPDATE P_imageFile
					SET IMAGEFILENAME =
					#{item.imageFileName}
					WHERE
					POST_NUM = #{item.post_num}
					AND
					IMAGEFILENO = #{item.imageFileNO}
				</when>
				<otherwise></otherwise>
			</choose>
		</foreach>
	</update>
	<!-- 이미지 추가 -->
	<insert id="insertModNewImage" parameterType="java.util.Map">
		<foreach collection="list" item="item" open="INSERT ALL"
			separator=" " close="SELECT * FROM DUAL">
			INTO P_imageFile (imageFileNO, imageFileName,
			post_num, regDate)
			VALUES
			(#{item.imageFileNO},#{item.imageFileName},#{item.post_num},sysdate)
		</foreach>
	</insert>

	<!-- 글삭제 -->
	<delete id="deleteBoard" parameterType="int">
		<![CDATA[
			DELETE FROM P_BOARD
			WHERE POST_NUM	= #{post_num}
		]]>
	</delete>
	
	<!-- 글삭제1 -->
	<delete id="deleteBoard1" parameterType="int">
		<![CDATA[
			DELETE FROM P_BOARD1
			WHERE POST_NUM	= #{post_num}
		]]>
	</delete>
	
	<!-- 이미지 삭제 -->
	<delete id="deleteModImage" parameterType="imageDTO">
		DELETE FROM
		P_imageFile
		WHERE POST_NUM = #{post_num}
		AND IMAGEFILENO =
		#{imageFileNO}
	</delete>

</mapper>